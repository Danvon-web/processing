<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Water Drop Game</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
</head>
<body>
    <script>
        let hand, waterImg;
        let backgrounds = [];
        let backgroundIndex = 0;
        let waters = [];
        let score = 0;
        let gameTime = 60;
        let gameStarted = false;
        let gameOver = false;
        let startbg;
        let customFont;
        
        function preload() {
            customFont = loadFont('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/webfonts/fa-solid-900.ttf'); // 替换为实际字体路径
            startbg = loadImage('1.png'); // 替换为你的开始界面背景图片
            for (let i = 0; i < 340; i++) {
                backgrounds[i] = loadImage(`data/1_${i}.png`);
            }
            waterImg = loadImage('water.png'); // 替换为水滴图像路径
            hand = loadImage('hand.png'); // 替换为手图像路径
        }

        function setup() {
            createCanvas(571, 800);
            textFont(customFont);
        }

        function draw() {
            background(255);
            if (!gameStarted) {
                // 开始界面
                showStartScreen();
            } else if (!gameOver) {
                // 游戏进行中
                runGame();
            } else {
                // 游戏结束，提示按空格重开
                showGameOverScreen();
            }
        }

        function mousePressed() {
            // 点击开始按钮开始游戏
            if (!gameStarted && mouseX >= 195 && mouseX <= 376 && mouseY >= 335 && mouseY <= 394) {
                gameStarted = true;
                score = 0;
                gameTime = 20;
                waters = [];
                backgroundIndex = 0;
                for (let i = 0; i < 10; i++) {
                    waters.push(new Water(random(width), random(height), waterImg));
                }
            }
        }

        function keyPressed() {
            // 按空格重新开始游戏
            if (gameOver && key === ' ') {
                gameStarted = false;
                gameOver = false;
            }
        }

        function showStartScreen() {
            // 绘制开始界面
            image(startbg, 285, 400);
            fill(0);
            textSize(35);
            textAlign(CENTER, CENTER);
            text("Welcome to the Water Drop Game!", width / 2, height / 2 - 153);
            textSize(24);
            text("Collect water beads for points within the specified time.", 288, 513);
            text(" Points can be exchanged for cat food to help stray cats.", 288, 583);
            // 绘制按钮
            fill(0, 150, 255);
            rect(216, 364, 140, 77, 10);
            fill(100);
            textSize(24);
            text("START", width / 2, height / 2);
        }

        function runGame() {
            // 显示背景图片
            image(backgrounds[backgroundIndex], width / 2, height / 2, width, height);
            // 显示并检测每个水滴
            for (let i = waters.length - 1; i >= 0; i--) {
                let w = waters[i];
                w.update();  // 更新水滴状态
                w.display(); // 显示水滴
                
                // 如果鼠标碰到水滴
                if (!w.isFalling && dist(mouseX, mouseY, w.x, w.y) < w.size / 2 + 30) {
                    score += 10;
                    w.startFalling(); // 鼠标碰到后，水滴开始下落
                    // 重新生成一个新的水滴
                    waters.push(new Water(random(width), random(height), waterImg));
                    
                    // 更新背景图片，显示下一张
                    if (backgroundIndex < backgrounds.length - 1) {
                        backgroundIndex++;
                    }
                }
                
                // 如果水滴掉出画布，移除它
                if (w.y > height) {
                    waters.splice(i, 1);
                }
            }
            
            // 显示手的位置
            image(hand, mouseX, mouseY);
            
            // 显示分数
            fill(255);
            textSize(32);
            text("Score: " + score, 139, 13);
            
            // 显示剩余时间
            textAlign(RIGHT, TOP);
            text("Time: " + gameTime, width - 47, 10);
            
            // 计时
            if (frameCount % 60 === 0 && gameTime > 0) {
                gameTime--;
            }
            
            // 游戏结束判断
            if (gameTime === 0 || score >= 500) {
                gameOver = true;
            }
        }

        function showGameOverScreen() {
            // 显示游戏结束界面
            fill(0);
            textSize(48);
            textAlign(CENTER, CENTER);
            text("Game Over!", width / 2, height / 2 - 50);
            
            // 显示得分
            textSize(32);
            text("Your Score: " + score, width / 2, height / 2);
            
            // 提示按空格重新开始
            textSize(24);
            text("Press SPACE to restart", width / 2, height / 2 + 50);
        }

        class Water {
            constructor(x, y, img) {
                this.x = x;
                this.y = y;
                this.img = img;
                this.size = img.width;
                this.velocityY = 2;
                this.isFalling = false;
            }

            update() {
                if (this.isFalling) {
                    this.y += this.velocityY;
                }
            }

            startFalling() {
                this.isFalling = true;
            }

            display() {
                image(this.img, this.x, this.y, this.size, this.size + 30);
            }
        }
    </script>
</body>
</html>
